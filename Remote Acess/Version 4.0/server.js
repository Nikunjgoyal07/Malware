const express = require("express");
const http = require("http");
const multer  = require('multer');
const upload = multer({ storage: multer.memoryStorage() });
const WebSocket = require("ws");
const fs = require('fs');
const path = require('path');
const readline = require("readline");

const app = express();
const server = http.createServer(app);
const wss = new WebSocket.Server({ server });

app.get("/", (req, res) => {
  res.send("WebSocket server is running.");
});

// WebSocket server logic
wss.on("connection", (ws) => {
  let counter = 1;
  ws.on('message', (message) => {
    if (message.length > 1000) { // Adjust this value as needed
      let filePath = path.join(__dirname, "uploads", `screenshot${counter}.png`);
      fs.writeFile(filePath, message, (err) => {
        if (err) {
          console.error('Error saving file:', err);
        } else {
          console.log("File saved successfully");
        }
      });}
});

  
    console.log("WebSocket connection established.");

    // Create readline interface
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
    });

    // Prompt for a message
    rl.question("Enter a message to send: ", (message) => {
      // Send the message
      ws.send(message);
      // Close the readline interface
      rl.close();
    });

    ws.on("message", (message) => {
      console.log(`Received: ${message}`);
    });
  
});



app.post('/upload', upload.single('file'), (req, res, next) => {
  console.log(req.file);
  fs.writeFile(path.join(__dirname, 'uploads', req.file.originalname), req.file.buffer, (err) => {
      if (err) throw err;
      console.log('File saved successfully');
  });
  res.send('File uploaded successfully.');
});

server.listen(8080, () => {
  console.log('Express server listening on port 8080');
});
